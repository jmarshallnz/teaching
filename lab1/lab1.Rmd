---
title: "227.215 Biostats Lab 1"
author: "Jonathan Marshall"
date: "15 July 2015"
graphics: yes
output:
  pdf_document: null
  html_document: default
---

## Introduction ##

In this lab we'll start looking at the linear model. The linear model forms the basis of much statistical analysis. It is the more general version of simple linear regression, and encompases regression, analysis of variance and many other situations. We'll also be looking at some extensions to the general linear model, such as mixed effects models which have particular application where data have been collected across multiple paddocks, farms or regions.

This lab will also be used to show you how to construct an `R notebook' which is a document that combines the R code for your analysis, any comments you make about that analysis, and any output form R, including plots. The neat thing about this is it encapsulates the concept of **repeatable research**: As you change your analysis steps (or make changes to the data), the report can be re-generated automatically. This document can take the form of an HTML document (great for previewing or sharing on the web) or a Word document that you can then edit further if needed.

## Exercise 1: Creating an RStudio project ##

In this exercise we'll get to know about RStudio projects. RStudio projects are a folder (in your Documents folder) that hold all the content for a set of analyses using RStudio. It is where any R scripts, along with your history, workspace, and also output documents are saved.

1. Start by loading up RStudio.
2. Next, create a new RStudio project by going to `File->New Project...`.
3. When prompted, select `New Directory`.
4. Next, select `Empty Project`.
5. Type in the name of the project (e.g. "BiostatsLabs") and select the folder you want it to be in (by default it will go into your "Documents" folder).

You'll see that RStudio will restart, and the Files pane down the bottom left will be inside the folder you created (and there'll be a Lab1.rproj file there).

Now, go and shut down RStudio, then navigate to `Documents/BiostatsLabs` in the Windows Explorer and open the `BiostatsLabs.Rproj` file. RStudio will re-start and you'll be back where you were.

## Exercise 2: Creating an R notebook from an R script ##

In this exercise we'll create a new R script, do some simple exploratory analysis, and then generate an R notebook from that.

1. Create a new R Script file to store the analysis we'll do today. To do this you can go to `File->New File->R Script` or alternatively click on the toolbar icon with the + on the left of it and select `R Script`.

2. Now type (or copy/paste) the following into the RScript file.

    ```
    #' 227.215 Biostats.
    
    #' In this notebook we'll take another look at data on Moroccan donkeys that we looked at
    #' in semester 1.
    donkey <- read.csv("http://www.massey.ac.nz/~jcmarsha/227215/data/donkey.csv")
    
    #' Take a look at it
    head(donkey)
    ```

3. You can highlight the code and click the `Run` button to execute it at any time. The code and output will go into the `Console` window.
4. Now we'll add a line to do a pairs plot of all the measurement variables on the donkeys.
```
#' A pairs plot of all measurement variables (columns 3 through 7)
plot(donkey[,3:7])
```

5. Run that code to make sure you get the plot you want.
6. Now we'll produce an R notebook. Click on the little spiral-bound notebook on the toolbar (it will say `Compile Notebook` when you hover over it). It will prompt you to first save your R script - call it something like `donkey.R`. Once done, select `HTML` as the type of notebook to compile. It will do it's thing, and produce an HTML document that should look something like what is below.

```{r, echo=FALSE, fig.width=3, fig.height=5, fig.align='center'}
library(png)
fig <- readPNG("r_notebook.png")
p <- par("fin")
par(mar=rep(0,4), fin=c(p[1], dim(fig)[1]/dim(fig)[2]*p[1]))
plot(c(0,dim(fig)[2]), c(0,dim(fig)[1]), type="n", xaxt="n", yaxt="n",xlab="", ylab="", xaxs="i", yaxs="i")
rasterImage(fig, 0, 0, dim(fig)[2], dim(fig)[1])
```

7. Try re-building the notebook and this time selecting `Word` as the type of notebook. It will generate a word document for you :)

## Exercise 3: The linear model ##

In this exercise we'll look at modelling the donkey `Bodywt` using the `Heartgirth`. You should be able to see from your plot that this was the best variable to use for modelling the `Bodywt`.

1. Change the line of code in your R script to just generate a scatterplot of `Bodywt` versus `Heartgirth`. To jog your memory, try
```
plot(Bodywt ~ Heartgirth, data=donkey)
```
  
2. Notice it is an increasing relationship, and is reasonably linear. We'll try and fit a straight line to these data. i.e. we'll try and fit a relationship that takes the form
  $$
  \mathsf{BodyWt} = a + b \times \mathsf{Heartgirth}
  $$
where $a$ is the **intercept**, and $b$ is the **slope** of the relationship. We need to figure out what $a$ and $b$ should be. We could do this by guessing using the graph (e.g. we could take a guess at $b$ by figuring out the rise over the run), but we've got a computer, so why not let it do it for us?  You can do this with the `lm` function, short for **linear model**. Try the following.
```
lm1 <- lm(Bodywt ~ Heartgirth, data=donkey)
```
This gives you a linear model object. To see what it contains, type the name of it `lm1`.

3. You can get more information by using the `summary` command on the `lm1` object. You should get output like
    ```{r echo=FALSE}
    donkey <- read.csv("http://www.massey.ac.nz/~jcmarsha/227215/data/donkey.csv")
    lm1 <- lm(Bodywt ~ Heartgirth, data=donkey)
    summary(lm1)
    ```
    Make sure you add both your model fitting line above, and the summary line to your R script. You might like to annotate it by adding a comment about what it is doing above it.
    Notice the summary command gives quite a lot of information. We'll go through some of it here.
    * We have two rows, one for the `Intercept`, and one labelled `Heartgirth` - this is the slope.
    * The `Estimate` column gives us the values of each of these parameters might be in the population.
    * The `Std. Error` column is a measure of how much out we might be in the estimation. The reason we have this is we have just a sample of donkeys - we haven't measured all possible Moroccan donkeys! So, just like a sample mean might be a bit out (and we use a confidence interval to estimate how much out we might be) the estimates of the intercept and slope might also be a bit out. The standard error is the standard deviation of those estimates. A 95% confidence interval for the slope would be:
$$
2.86 \pm 2 \times 0.072,
$$
just like the confidence interval for a mean.
    * The `t value` column is giving the number of standard deviations away from 0 the slope and intercept estimates are (i.e. $39.63 = 2.85517 / 0.07205$).
    * The `Pr(>|t|)` column is the P-values for each of these estimates. The null hypothesis being tested is whether the slope (or intercept) is zero.
    * Finally, in the bit underneath, notice the `Multiple R-squared` value of 0.80. This means that 80% of the variation in the body weight is explained by the linear model.

4. Write down the equation that relates the Body weight to the Heartgirth.

5. Think about what the P-value for the slope means. What would be your conclusion for this? Write some notes about this into your R-script as comments (i.e. pre-fixed using hash-quote `#' `) If you're not sure, discuss with those around you, or with Jonathan, Penny or Khair.

6. Think about what the $R^2$ value means for the relationship between body weight and heartgirth. Write some notes about this into your R-script as comments.

7. Suppose you wanted to predict the weight of a donkey. You measure the girth at the heart and find it is 110cm. What is your best guess as to the body weight?  *Hint: Use the equation to work this out.*

8. Let's re-do part 7 using R. We do this by creating a data frame with the data to predict on, and then use the `predict` function. Add the following to your R script
```
#' predict the weight of a donkey with heart girth 110cm
new_data <- data.frame(Heartgirth = 110)
predict(lm1, new_data)
```
9. We can improve this prediction by taking into account how much variation we expect this prediction to have. The variation comes from two sources:
    * The potential error in the line itself (we have just a sample, so our slope and intercept contain some error).
    * The variation of individuals about the line (i.e. variation not explained by the model).

    We can account for either the first or both of these in our predictions. Try the following:
    ```
    predict(lm1, new_data, interval="confidence")
    predict(lm1, new_data, interval="prediction")
    ```
    The first accounts only for the error in the line itself. That is, it is a *confidence* interval for the **average** weight for all donkeys with heartgirth 110cm.  The second accounts for the error in the line plus the variation of individuals about the line. Thus, it gives a *prediction* interval for the weight of an **individual** donkey with heartgirth 110cm. This is the range we expect individuals to be in.